---
- name: mount data drives # noqa: command-instead-of-module no-changed-when
  command: mount -a
  listen: mount data drives

- name: verify data drives mounted # noqa: no-changed-when
  command: "mountpoint -q {{ item }}"
  loop: "{{ disk_directories }}"
  listen: mount data drives
  when: disk_directories is defined

- name: mount parity drives # noqa: command-instead-of-module no-changed-when
  command: mount -a
  listen: mount parity drives

- name: verify parity drives mounted # noqa: no-changed-when
  command: "mountpoint -q {{ item }}"
  loop: "{{ parity_directories }}"
  listen: mount parity drives
  when: parity_directories is defined and parity_directories | length > 0

- name: reload systemd
  systemd:
    daemon_reload: true

- name: restart nfs-kernel-server
  service:
    name: nfs-kernel-server
    state: restarted

- name: restart snapraid-runner
  service:
    name: snapraid-runner.timer
    state: restarted
    enabled: true

- name: mount mergerfs # noqa: command-instead-of-module no-changed-when
  command: mount /mnt/storage
  listen: mount mergerfs

- name: verify mergerfs mounted # noqa: no-changed-when
  command: mountpoint -q /mnt/storage
  listen: mount mergerfs

- name: initial snapraid sync
  include_tasks: snapraid_initial_sync.yml
  listen: initial snapraid sync

- name: reload nfs exports # noqa: no-changed-when
  command: exportfs -ra
  listen: reload nfs exports

- name: restart networking debian
  service:
    name: networking
    state: restarted
  listen: restart networking debian

- name: restart networking redhat
  service:
    name: NetworkManager
    state: restarted
  listen: restart networking redhat

# =================================================================
# KUBERNETES CONNECTIVITY TEST (Optional)
# =================================================================

- name: Check if kubectl is available
  command: which kubectl
  register: kubectl_check
  changed_when: false
  failed_when: false

- name: Check if kubeconfig exists
  stat:
    path: "{{ lookup('env', 'KUBECONFIG') }}"
  register: kubeconfig_check
  when: kubectl_check.rc == 0

- name: Kubernetes NFS validation
  when:
    - kubectl_check.rc == 0
    - kubeconfig_check.stat.exists | default(false)
  block:
    - name: Create NFS test namespace
      command: kubectl create namespace nfs-validation-test --dry-run=client -o yaml
      register: namespace_yaml
      changed_when: false

    - name: Apply NFS test namespace
      shell: |
        set -o pipefail
        echo '{{ namespace_yaml.stdout }}' | kubectl apply -f -
      changed_when: true

    - name: Create NFS test pod manifest
      copy:
        content: |
          apiVersion: v1
          kind: Pod
          metadata:
            name: nfs-test-pod
            namespace: nfs-validation-test
          spec:
            containers:
            - name: nfs-test
              image: busybox:latest
              command: ["/bin/sh", "-c"]
              args:
                - |
                  echo "Testing NFS mount..." &&
                  echo "NFS test from Kubernetes - $(date)" > /mnt/nfs/.k8s_nfs_test &&
                  cat /mnt/nfs/.k8s_nfs_test &&
                  rm /mnt/nfs/.k8s_nfs_test &&
                  echo "NFS test passed!" &&
                  sleep 10
              volumeMounts:
              - name: nfs-volume
                mountPath: /mnt/nfs
            volumes:
            - name: nfs-volume
              nfs:
                server: "{{ ansible_host }}"
                path: /mnt/storage/Temp
            restartPolicy: Never
        dest: /tmp/nfs-test-pod.yaml
        mode: "0644"

    - name: Deploy NFS test pod
      command: kubectl apply -f /tmp/nfs-test-pod.yaml
      changed_when: true

    - name: Wait for NFS test pod to complete
      command: kubectl wait --for=jsonpath='{.status.phase}'=Succeeded pod/nfs-test-pod -n nfs-validation-test --timeout=60s
      register: pod_wait
      failed_when: false
      changed_when: false

    - name: Get NFS test pod logs
      command: kubectl logs nfs-test-pod -n nfs-validation-test
      register: pod_logs
      failed_when: false
      changed_when: false

    - name: Display NFS test pod logs
      debug:
        msg: "{{ pod_logs.stdout_lines }}"
      when: pod_logs.rc == 0

    - name: Cleanup NFS test pod
      command: kubectl delete pod nfs-test-pod -n nfs-validation-test --ignore-not-found
      changed_when: false
      failed_when: false

    - name: Cleanup NFS test namespace
      command: kubectl delete namespace nfs-validation-test --ignore-not-found
      changed_when: false
      failed_when: false

    - name: Remove test pod manifest
      file:
        path: /tmp/nfs-test-pod.yaml
        state: absent

    - name: Verify Kubernetes NFS test succeeded
      assert:
        that:
          - pod_logs.rc == 0
          - "'NFS test passed!' in pod_logs.stdout"
        success_msg: "Kubernetes NFS connectivity test passed"
        fail_msg: "Kubernetes NFS connectivity test failed"
      when: pod_logs.rc == 0

- name: Skip Kubernetes test if kubectl not available
  debug:
    msg: "Skipping Kubernetes NFS validation - kubectl not available or kubeconfig not found"
  when: kubectl_check.rc != 0 or not (kubeconfig_check.stat.exists | default(false))

---
# NFS Firewall Configuration
# Configures UFW firewall rules for NFS services

- name: Check if UFW is installed
  command: which ufw
  register: ufw_check
  changed_when: false
  failed_when: false

- name: Install UFW if requested
  package:
    name: ufw
    state: present
  when:
    - install_ufw
    - ufw_check.rc != 0

- name: Re-check UFW availability after installation
  command: which ufw
  register: ufw_available
  changed_when: false
  failed_when: false

- name: Display firewall status
  debug:
    msg: "UFW is {{ 'available' if ufw_available.rc == 0 else 'not available' }}"

- name: Configure and validate UFW firewall
  when: ufw_available.rc == 0
  block:
    - name: Check UFW status
      command: ufw status
      register: ufw_status
      changed_when: false
      failed_when: false

    - name: Set UFW default deny incoming
      ufw:
        direction: incoming
        policy: deny

    - name: Set UFW default allow outgoing
      ufw:
        direction: outgoing
        policy: allow

    - name: Allow SSH access
      ufw:
        rule: allow
        src: "{{ item }}"
        port: "22"
        proto: tcp
        comment: "SSH 22/tcp"
      loop: "{{ firewall_allowed_networks }}"
      loop_control:
        label: "{{ item }} -> 22/tcp"

    - name: Allow NFS TCP ports
      ufw:
        rule: allow
        src: "{{ item.0 }}"
        port: "{{ item.1 }}"
        proto: tcp
        comment: "NFS {{ item.1 }}/tcp"
      loop: "{{ firewall_allowed_networks | product(['111', '2049', '20048']) | list }}"
      loop_control:
        label: "{{ item.0 }} -> {{ item.1 }}/tcp"

    - name: Allow NFS UDP ports
      ufw:
        rule: allow
        src: "{{ item.0 }}"
        port: "{{ item.1 }}"
        proto: udp
        comment: "NFS {{ item.1 }}/udp"
      loop: "{{ firewall_allowed_networks | product(['111', '2049']) | list }}"
      loop_control:
        label: "{{ item.0 }} -> {{ item.1 }}/udp"

    - name: Enable UFW if not active
      ufw:
        state: enabled
      when: "'Status: active' not in ufw_status.stdout"

    - name: Display firewall rules
      command: ufw status numbered
      register: ufw_rules
      changed_when: false

    - name: Show configured firewall rules
      debug:
        msg: "{{ ufw_rules.stdout_lines }}"
      when: ufw_rules.stdout_lines is defined

    - name: Verify NFS firewall rules
      shell: |
        set -o pipefail
        ufw status | grep -E '(111|2049|20048)'
      register: nfs_ports_check
      changed_when: false
      failed_when: false

    - name: Assert NFS firewall rules are present
      assert:
        that:
          - nfs_ports_check.rc == 0
          - "'111' in nfs_ports_check.stdout"
          - "'2049' in nfs_ports_check.stdout"
        success_msg: "NFS firewall rules are properly configured"
        fail_msg: "NFS firewall rules are missing or incomplete"

- name: Warn if UFW is not available
  debug:
    msg: "WARNING: UFW is not installed. NFS ports may be blocked by firewall."
  when: ufw_available.rc != 0

---
- name: Build mergerfs mount options
  set_fact:
    mergerfs_branches: "{{ disk_directories | join(':') }}"
    mergerfs_systemd_requires: "{{ disk_directories | map('regex_replace', '^/', '') | map('regex_replace', '/', '-') | map('regex_replace', '$', '.mount') | list }}" # noqa yaml[line-length]

- name: Build mergerfs fstab options
  set_fact:
    mergerfs_options: >-
      defaults,allow_other,use_ino,cache.files=off,category.create=epmfs,{{
        mergerfs_systemd_requires | map('regex_replace', '^', 'x-systemd.requires=') | join(',')
      }}

- name: Mount mergerfs pool
  mount:
    path: /mnt/storage
    src: "{{ mergerfs_branches }}"
    fstype: fuse.mergerfs
    opts: "{{ mergerfs_options }}"
    # The passno is the 6th field in /etc/fstab. It tells fsck (filesystem check at boot) the order to check filesystems:
    # - 0 — don't check
    # - 1 — check first (root filesystem)
    # - 2 — check after root
    #
    # For FUSE filesystems like mergerfs, there is no fsck.fuse.mergerfs — the kernel doesn't know how to check them.
    # If passno were non-zero, the boot process would attempt to fsck the FUSE mount and either fail or stall.
    # In practice, ansible.posix.mount defaults passno to 0 when unspecified,
    # so this is more about explicitness and consistency.
    passno: "0"
    state: mounted
    backup: true

- name: Validate mergerfs mount
  include_tasks: mount_validation.yml

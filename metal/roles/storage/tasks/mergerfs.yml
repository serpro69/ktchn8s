---
- name: Create mergerfs mount configuration
  set_fact:
    mergerfs_branches: "{{ disk_directories | join(':') }}"
    mergerfs_options: "defaults,allow_other,use_ino,cache.files=partial,dropcacheonclose=true,category.create=mfs"
    # TODO: I think nonempty is removed in FUSE3?
    # mergerfs_options: "defaults,nonempty,allow_other,use_ino,cache.files=partial,dropcacheonclose=true,category.create=mfs"

- name: Add mergerfs mount to fstab
  lineinfile:
    path: /etc/fstab
    line: "{{ mergerfs_branches }} /mnt/storage fuse.mergerfs {{ mergerfs_options }} 0 0"
    state: present
    backup: true
  notify: mount mergerfs

- name: Create NFS export directories
  file:
    path: "/mnt/storage/{{ item }}"
    state: directory
    mode: "0755"
    owner: root
    group: root
  loop: "{{ storage_dirs }}"
  when: mergerfs_branches is defined

- name: Check if mergerfs is already mounted
  command: mountpoint -q /mnt/storage
  register: mergerfs_already_mounted
  failed_when: false
  changed_when: false

- name: Mount mergerfs pool # noqa command-instead-of-module no-changed-when
  command: mount /mnt/storage
  when: mergerfs_already_mounted.rc != 0
  register: mergerfs_mount_result

- name: Validate mergerfs mount
  include_tasks: mount_validation.yml
  when: mergerfs_mount_result is changed or mergerfs_already_mounted.rc == 0

---
# NFS Export Validation
# Verifies NFS exports are properly configured and accessible

# =================================================================
# LOCAL NFS VALIDATION
# =================================================================

- name: Check NFS server service status
  systemd:
    name: "{{ nfs_server_service }}"
  register: nfs_service_status
  failed_when: false

- name: Verify NFS service is running
  assert:
    that:
      - nfs_service_status.status.ActiveState == "active"
    fail_msg: "NFS server service is not running"
    success_msg: "NFS server service is active"

- name: Check rpcbind service status
  systemd:
    name: rpcbind
  register: rpcbind_status
  failed_when: false

- name: Verify rpcbind service is running
  assert:
    that:
      - rpcbind_status.status.ActiveState == "active"
    fail_msg: "rpcbind service is not running"
    success_msg: "rpcbind service is active"

- name: Verify NFS exports are visible
  command: showmount -e localhost
  register: showmount_result
  changed_when: false
  failed_when: showmount_result.rc != 0

- name: Parse exported directories
  set_fact:
    exported_dirs: "{{ showmount_result.stdout_lines[1:] | map('regex_replace', '^(/\\S+).*', '\\1') | list }}"
  when: showmount_result.stdout_lines | length > 1

- name: Display exported directories
  debug:
    msg: "Exported NFS directories: {{ exported_dirs | join(', ') }}"
  when: exported_dirs is defined

- name: Verify expected exports are present
  assert:
    that:
      - "'/mnt/storage/' + item in exported_dirs"
    fail_msg: "NFS export missing: /mnt/storage/{{ item }}"
    success_msg: "NFS export present: /mnt/storage/{{ item }}"
  loop: "{{ storage_dirs }}"
  when: exported_dirs is defined

- name: Check if ufw firewall is active
  command: ufw status
  register: ufw_status
  changed_when: false
  failed_when: false

- name: Verify NFS firewall rules (if ufw is active)
  when: "'Status: active' in ufw_status.stdout"
  block:
    - name: Check NFS port firewall rules
      shell: |
        set -o pipefail
        ufw status numbered | grep -E '(111|2049|20048)'
      register: firewall_rules
      changed_when: false
      failed_when: false

    - name: Display firewall status
      debug:
        msg: "NFS firewall rules are configured"
      when: firewall_rules.rc == 0

    - name: Warn if firewall rules missing
      debug:
        msg: "WARNING: NFS firewall rules may not be configured correctly"
      when: firewall_rules.rc != 0

- name: Test local NFS mount capability
  block:
    - name: Create test mount point
      file:
        path: /tmp/nfs_test_mount
        state: directory
        mode: "0755"

    - name: Test mount NFS export locally # noqa command-instead-of-module
      command: "mount -t nfs localhost:/mnt/storage/Temp /tmp/nfs_test_mount"
      register: test_mount
      changed_when: false
      failed_when: false

    - name: Test write to NFS mount
      copy:
        content: "NFS validation test - {{ ansible_date_time.iso8601 }}"
        dest: /tmp/nfs_test_mount/.nfs_test_file
        mode: "0644"
      when: test_mount.rc == 0
      register: test_write

    - name: Test read from NFS mount
      command: cat /tmp/nfs_test_mount/.nfs_test_file
      when: test_write is succeeded
      register: test_read
      changed_when: false

    - name: Cleanup test file
      file:
        path: /tmp/nfs_test_mount/.nfs_test_file
        state: absent
      when: test_write is succeeded

    - name: Unmount test NFS share
      command: umount /tmp/nfs_test_mount
      when: test_mount.rc == 0
      changed_when: false

    - name: Remove test mount point
      file:
        path: /tmp/nfs_test_mount
        state: absent

    - name: Verify local NFS mount test succeeded
      assert:
        that:
          - test_mount.rc == 0
          - test_write is succeeded
          - test_read is succeeded
        success_msg: "Local NFS mount test passed"
        fail_msg: "Local NFS mount test failed"

# =================================================================
# REMOTE NFS VALIDATION (from controller)
# =================================================================
# Only tests network reachability and export visibility via showmount.
# The actual mount/write/read test is covered by the local NFS test above
# and the K8s pod test in k8s_validation.yml.

- name: Test NFS access from controller
  delegate_to: localhost
  become: false
  block:
    - name: Verify NFS exports visible from controller
      command: "showmount -e {{ ansible_host }}"
      register: remote_showmount
      changed_when: false
      failed_when: false

    - name: Verify remote showmount succeeded
      assert:
        that:
          - remote_showmount.rc == 0
        fail_msg: "Cannot reach NFS exports from controller - check firewall and network connectivity"
        success_msg: "NFS exports visible from controller"

    - name: Parse remote exported directories
      set_fact:
        remote_exported_dirs: "{{ remote_showmount.stdout_lines[1:] | map('regex_replace', '^(/\\S+).*', '\\1') | list }}"
      when: remote_showmount.stdout_lines | length > 1

    - name: Verify expected exports visible from controller
      assert:
        that:
          - "'/mnt/storage/' + item in remote_exported_dirs"
        fail_msg: "NFS export not visible from controller: /mnt/storage/{{ item }}"
        success_msg: "NFS export visible from controller: /mnt/storage/{{ item }}"
      loop: "{{ storage_dirs }}"
      when: remote_exported_dirs is defined

- name: NFS validation complete
  debug:
    msg: "NFS export validation completed successfully (local and remote)"
